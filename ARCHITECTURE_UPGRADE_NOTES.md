# 架构重构升级说明

## 🎯 核心目标

本次架构重构实现了三大核心功能：
1. **ChromaDB 向量记忆系统（RAG）** - 智能关联历史项目
2. **可视化的任务处理队列** - 实时显示处理进度
3. **页面切换锁定机制** - 防止分析任务中断

## ✨ 主要功能

### 1. ChromaDB 向量记忆系统

#### MemoryManager 类（单例模式）
- **模型缓存**：使用 `@st.cache_resource` 装饰器缓存 Embedding 模型，避免重复下载
- **自动降级**：如果 ChromaDB 初始化失败，系统自动降级运行（不启用 RAG）
- **持久化存储**：数据存储在 `./chroma_db` 目录

#### 核心方法
- `query_similar(text, top_k=3)`: 查询相似历史项目
- `add_memory(name, summary, full_text, score, meta)`: 添加项目到向量库
- `get_count()`: 获取知识库项目数量

#### RAG 工作流程
1. 分析前：从文件文本中检索相似的历史项目
2. Prompt 增强：将相似项目信息添加到 System Prompt
3. 分析后：自动将新项目存入向量库

### 2. 可视化任务处理队列

#### 任务队列 UI
- **初始化阶段**：为每个文件创建占位符，显示 `⏳ 等待处理`
- **处理阶段**：实时更新状态为 `🔄 正在深入分析 (关联知识库中...)`
- **完成阶段**：立即渲染最终结果，包含 checkbox 和 expander

#### 状态管理
- 使用 `st.session_state` 持久化所有结果
- 页面刷新后自动恢复任务队列
- 每个任务的进度独立显示

### 3. 页面切换锁定机制

#### 状态锁定
- `is_analyzing` 状态变量控制分析进程
- 分析期间：侧边栏导航禁用，显示警告提示
- 防止用户切换页面导致任务中断

#### 状态恢复
- 即使切换到其他页面，返回工作台后任务继续执行
- 所有配置信息保存在 session_state 中
- 任务完成后自动解除锁定

## 🔧 技术实现

### 依赖库
```bash
pip install chromadb sentence-transformers
```

如果未安装，系统会：
- 显示提示信息
- 降级运行（不启用 RAG 功能）
- 不影响核心分析功能

### Embedding 模型
- 模型名称：`all-MiniLM-L6-v2`
- 首次运行：自动下载（可能需要 1 分钟）
- 缓存机制：使用 `@st.cache_resource` 避免重复加载

### 异常处理
- ChromaDB 初始化失败 → 降级运行
- Embedding 模型加载失败 → 降级运行
- RAG 查询失败 → 继续正常分析
- 所有错误都有友好的提示信息

## 📋 使用说明

### 首次运行
1. 安装依赖：`pip install chromadb sentence-transformers`
2. 运行应用：`streamlit run app.py`
3. 首次初始化：系统会自动下载 Embedding 模型（约 1 分钟）

### 批量分析流程
1. **上传文件**：选择多个 PDF/DOCX 文件
2. **开始分析**：点击"🚀 开始批量分析"
3. **实时查看**：
   - 看到每个文件的状态更新
   - 显示 RAG 检索的相似项目信息
   - 查看分析结果
4. **自动入库**：分析完成后自动存入向量库

### RAG 功能说明
- **自动检索**：分析前自动查找相似历史项目
- **智能对比**：AI 会参考相似项目，指出差异化优势
- **知识积累**：每次分析后自动学习，知识库越来越智能

## ⚠️ 注意事项

1. **首次运行**：下载 Embedding 模型需要时间，请耐心等待
2. **磁盘空间**：ChromaDB 数据存储在 `./chroma_db` 目录
3. **性能优化**：模型使用缓存机制，重启应用后无需重新加载
4. **降级运行**：即使 RAG 功能不可用，核心分析功能完全正常

## 🔄 后续优化建议

1. **向量库管理**：添加删除、更新向量库项目的功能
2. **相似度阈值**：支持自定义相似度阈值，过滤低质量匹配
3. **批量导入**：支持从 CSV 批量导入历史项目到向量库
4. **可视化**：添加向量库项目的可视化展示
