# 基于 LLM 标签提取的轻量级记忆系统升级说明

## 🎯 升级原因

由于用户本地环境特殊，无法安装 numpy/torch 等数学库，已完全放弃向量检索方案（ChromaDB + sentence-transformers），改用**纯 Python 原生实现的基于 LLM 标签提取的轻量级记忆系统**。

## ✨ 新系统特点

### 1. 零依赖
- **纯 Python 实现**：不需要任何第三方计算库（numpy, torch, chromadb, sentence-transformers）
- **JSON 存储**：使用本地 `memory_store.json` 文件存储数据
- **轻量级**：无需下载大型模型，无需额外配置

### 2. 基于标签匹配
- **标签提取**：使用 LLM 从项目文本中提取 3-5 个核心标签
- **标签匹配**：通过计算标签交集来找到相似项目
- **智能排序**：按匹配度（共同标签比例）排序

### 3. 数据结构

记忆库文件 `memory_store.json` 格式：

```json
[
  {
    "id": "项目名",
    "summary": "一句话核心评价",
    "score": 8,
    "tags": ["AI", "医疗", "B2B", "SaaS"],
    "timestamp": "2024-01-01T12:00:00",
    "industry": "AI Agent",
    "stage": "Pre-A",
    "risk_level": "Medium"
  }
]
```

## 🔧 技术实现

### MemoryManager 类（单例模式）

#### 核心方法

1. **`query_similar(text, client, model, top_k=3)`**
   - 使用 LLM 提取当前项目的标签
   - 与历史项目的标签进行匹配
   - 计算匹配度（共同标签数 / 最大标签数）
   - 返回匹配度最高的 top_k 个项目

2. **`add_memory(name, summary, full_text, score, tags, meta)`**
   - 从 LLM 响应 JSON 中提取标签（如果存在）
   - 如果 JSON 中没有标签，调用 LLM 提取
   - 存储到 `memory_store.json` 文件

3. **`get_count()`**
   - 返回记忆库中的项目数量

### 标签提取函数

**`extract_tags_from_text(text, client, model)`**
- 调用 LLM 从项目文本中提取 3-5 个核心标签
- 返回标签列表（如：["AI", "医疗", "B2B", "SaaS"]）

## 📋 工作流程

### 分析新项目时：

1. **提取文件文本**
2. **标签提取**：使用 LLM 提取当前项目的标签
3. **相似项目检索**：
   - 遍历记忆库中的所有项目
   - 计算每个历史项目的标签匹配度
   - 选择匹配度最高的 3 个项目
4. **Prompt 增强**：将相似项目信息添加到 System Prompt
5. **LLM 分析**：执行分析，获得结果
6. **存储记忆**：
   - 从分析结果 JSON 中提取标签（如果存在）
   - 如果 JSON 中没有标签，再次调用 LLM 提取
   - 保存到 `memory_store.json`

### 匹配算法

```
匹配度 = 共同标签数 / max(当前项目标签数, 历史项目标签数)
```

示例：
- 当前项目标签：["AI", "医疗", "B2B"]
- 历史项目标签：["AI", "医疗", "SaaS"]
- 共同标签：["AI", "医疗"] (2个)
- 匹配度 = 2 / max(3, 3) = 0.67

## 📁 文件结构

```
GP_Partner_Clean/
├── app.py                 # 主程序（已更新）
├── memory_store.json      # 记忆库文件（自动生成）
├── prompts/               # 提示词文件夹
├── history_data/          # 历史记录文件夹
└── project_database.csv   # 项目数据库（CSV 格式）
```

## 🚀 使用说明

### 首次运行

1. 系统会自动创建 `memory_store.json` 文件
2. 记忆库为空时，不会进行相似项目检索
3. 分析完第一个项目后，会自动提取标签并存储

### 后续分析

1. 上传新项目文件
2. 系统自动提取标签并匹配相似项目
3. LLM 会参考相似项目进行分析
4. 分析完成后自动存储到记忆库

## ⚙️ 配置说明

### 标签提取 Prompt

标签提取使用的 Prompt 可以根据需要调整，位于 `extract_tags_from_text` 函数中。

默认要求：
- 提取 3-5 个核心标签
- 标签应该是项目的核心技术、行业、商业模式等关键特征
- 格式：纯文本，用逗号分隔

### 匹配阈值

当前实现返回匹配度 > 0 的所有项目（即至少有一个共同标签）。如果需要提高匹配质量，可以修改 `query_similar` 方法，添加最小匹配度阈值。

## 📊 性能特点

### 优点
- ✅ **零依赖**：不需要任何数学库或向量数据库
- ✅ **轻量级**：JSON 文件存储，读写快速
- ✅ **可解释**：标签匹配，结果可解释性强
- ✅ **易维护**：纯文本 JSON 文件，易于查看和编辑

### 限制
- ⚠️ **匹配精度**：基于标签匹配，可能不如向量相似度精确
- ⚠️ **标签质量依赖 LLM**：标签提取质量影响匹配效果
- ⚠️ **规模限制**：当项目数量很大时（>1000），查询效率可能下降

## 🔄 迁移说明

### 从向量检索系统迁移

如果之前使用了 ChromaDB，数据不会自动迁移。需要：
1. 手动导出历史项目的标签
2. 或重新分析历史项目，系统会自动提取标签

### 数据格式兼容

新的记忆系统与 CSV 数据库独立，两者可以并存：
- `memory_store.json`：用于相似项目检索（基于标签）
- `project_database.csv`：用于数据分析和导出

## 🐛 故障排除

### 问题：标签提取失败

**原因**：LLM API 调用失败或返回格式不正确

**解决**：
- 检查 API Key 是否正确
- 查看终端错误日志
- 系统会自动降级（不使用相似项目参考）

### 问题：匹配不到相似项目

**原因**：
- 记忆库为空
- 标签不匹配（没有共同标签）

**解决**：
- 正常情况，系统会继续分析（不参考历史项目）
- 可以手动调整标签或增加记忆库内容

### 问题：memory_store.json 文件损坏

**解决**：
- 备份文件后删除，系统会创建新的空文件
- 或手动修复 JSON 格式

## 📝 未来优化建议

1. **标签优化**：支持用户手动编辑标签，提高匹配精度
2. **模糊匹配**：支持标签的同义词匹配（如"AI" 和 "人工智能"）
3. **标签分类**：区分技术标签、行业标签、商业模式标签等
4. **批量导入**：支持从 CSV 批量导入并自动提取标签
