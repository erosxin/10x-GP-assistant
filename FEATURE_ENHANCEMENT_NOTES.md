# 功能增强更新说明

## 🎯 核心目标

本次更新实现了三大核心功能：
1. **显性化展示 RAG 记忆与联想过程** - 不再黑盒，可视化展示 AI 思考路径
2. **恢复 Prompt 自我进化建议机制** - AI 自动反思并给出优化建议
3. **修复分数提取 Bug** - 支持多种分数格式，提高提取成功率

## ✨ 主要功能

### 1. 显性化 RAG 记忆展示

#### Prompt 格式要求
LLM 现在必须严格按照以下格式输出：

1. **头部（Tags）**：
   ```
   ---TAGS: ["标签1", "标签2", "标签3", "标签4", "标签5"]---
   ```

2. **中间（正文）**：
   正常的 Markdown 分析报告

3. **尾部（进化建议）**：
   ```
   ## 🧬 进化建议
   [针对本次分析的 Prompt 优化建议]
   ```

4. **JSON 数据块**：
   ```json
   {
     "project_name": "...",
     "score": 8,
     ...
   }
   ```

#### UI 展示 - "大脑思考路径"
在分析结果展开时，显示：

- **核心关键词**：显示提取到的标签
- **记忆激活状态**：
  - 如果找到相似项目：`🎯 记忆激活: 发现与历史项目 [项目A], [项目B] 存在关联（共同标签: ...），已进行横向对比。`
  - 如果没找到：`🌱 新物种收录: 知识库中暂无同类，已作为种子存入大脑。`

### 2. Prompt 自我进化建议机制

#### 自动提取
- 从 LLM 响应末尾提取 `## 🧬 进化建议` 后的内容
- 自动保存到 `evolution_log.md` 文件
- 带上时间戳和项目名

#### 侧边栏展示
- 在侧边栏底部添加 `🧬 查看 AI 进化日志` expander
- 实时显示所有进化建议
- 方便用户查看并优化 Prompt

### 3. 增强的分数提取

#### 提取策略（按优先级）

1. **从 JSON 数据中提取**（最准确）
   - 直接读取 `json_data['score']`

2. **在前 1000 字符中搜索**（多种格式）
   - `Score: 8`
   - `评分：8.5`
   - `[8分]`
   - `评分: 8`
   - `8 分`
   - `8 / 10`

3. **全文搜索 x/10 格式**（兜底策略）
   - 查找所有 `x/10` 格式的数字
   - 验证范围（1-10）

#### 支持的格式示例
- `Score: 8`
- `评分：8.5`
- `[8分]`
- `8 / 10`
- `评分: 8`
- `8 分`

## 🔧 技术实现

### 新增函数

1. **`extract_tags_from_response(response_text)`**
   - 从响应头部提取 `---TAGS: [...]---` 格式的标签
   - 如果未找到，从 JSON 数据块中提取

2. **`extract_evolution_suggestion(response_text)`**
   - 提取 `## 🧬 进化建议` 章节后的内容
   - 使用正则表达式匹配

3. **`extract_score_enhanced(response_text, json_data)`**
   - 增强的分数提取，支持多种格式
   - 多级兜底策略

4. **`parse_llm_response(response_text)`**
   - 统一解析函数，提取所有结构化信息
   - 返回：tags, json_data, score, evolution_suggestion, body_content

5. **`save_evolution_suggestion(project_name, suggestion)`**
   - 保存进化建议到 `evolution_log.md`
   - 自动添加时间戳

### 修改的函数

1. **`enhance_system_prompt()`**
   - 更新格式要求，强制 LLM 输出特定结构

2. **`process_single_file()`**
   - 使用 `parse_llm_response()` 解析响应
   - 保存进化建议
   - 返回包含 tags、similar_projects 等信息的完整结果

3. **`render_result_row()`**
   - 添加"大脑思考路径"展示
   - 显示标签、记忆激活状态

4. **`clean_markdown_for_display()`**
   - 移除 Tags 头部
   - 移除进化建议章节
   - 移除 JSON 代码块

## 📁 新增文件

- `evolution_log.md` - AI 进化日志文件（自动生成）

格式示例：
```markdown
---
## 2024-01-01 12:00:00 - 项目名称

建议在提示词中增加对XX赛道的特殊关注...
建议明确要求分析XX维度的风险...
```

## 🎨 UI 改进

### 分析结果展示
- **大脑思考路径**：醒目的 info 提示框
- **核心关键词**：标签列表展示
- **记忆激活状态**：成功/信息提示框
- **正文内容**：清理后的 Markdown 报告

### 侧边栏
- **AI 进化日志**：底部 expander，实时查看所有建议

## 🐛 Bug 修复

### 分数提取问题
- **问题**：部分项目显示 `[N/A]` 分数
- **原因**：正则表达式太严格，只搜索末尾
- **解决**：
  - 扩大搜索范围（前 1000 字符）
  - 支持多种格式
  - 多级兜底策略

## 📋 使用说明

### 分析流程

1. **上传文件并开始分析**
2. **查看实时状态**：`🔄 正在深入分析 (关联知识库中...)`
3. **查看结果**：
   - 展开结果查看"大脑思考路径"
   - 了解 AI 如何思考和分析
   - 查看记忆激活状态

### 查看进化建议

1. 在侧边栏底部展开 `🧬 查看 AI 进化日志`
2. 查看所有历史建议
3. 根据建议优化 Prompt 文件

### 优化 Prompt

1. 查看进化日志中的建议
2. 编辑 `prompts/` 文件夹中的 `.txt` 文件
3. 应用建议，提升分析质量

## ⚠️ 注意事项

1. **格式要求**：LLM 必须严格按照新格式输出，否则可能无法正确解析
2. **标签提取**：如果 LLM 未输出 Tags 头部，会尝试从 JSON 中提取
3. **进化建议**：如果 LLM 未输出进化建议章节，不会报错，只是不保存
4. **分数提取**：如果所有策略都失败，会显示 `N/A`，但不会中断流程

## 🔄 向后兼容

- 所有原有功能保持不变
- 历史记录仍然保存完整内容
- 如果 LLM 未按新格式输出，系统会降级处理（尝试从 JSON 中提取）

## 📊 效果展示

### 大脑思考路径示例

```
🧠 大脑思考路径

核心关键词: `AI`, `医疗`, `B2B`, `SaaS`

🎯 记忆激活: 发现与历史项目 `项目A`, `项目B` 存在关联（共同标签: AI, 医疗），已进行横向对比。
```

或

```
🧠 大脑思考路径

核心关键词: `区块链`, `DeFi`, `Web3`

🌱 新物种收录: 知识库中暂无同类，已作为种子存入大脑。
```
