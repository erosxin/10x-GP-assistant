# 项目知识库功能升级说明

## 🎯 升级概述

本次升级为 GP Partner Ultimate 添加了**项目知识库自动积累功能**，系统会在每次分析完成后自动提取并存储项目结构化信息。

## ✨ 新增功能

### 1. 自动提取项目信息
- AI 分析完成后，自动从响应中提取结构化 JSON 数据
- 包含字段：项目名称、行业、技术标签、融资阶段、评分、核心评价、风险等级

### 2. 知识库自动积累
- 自动将提取的项目信息保存到 `project_database.csv`
- 使用 `utf-8-sig` 编码，完美支持中文，避免 Windows Excel 乱码
- 每次分析自动追加新记录，无需手动操作

### 3. 侧边栏知识库展示
- 在侧边栏新增"📂 项目知识库"分区
- 显示项目总数统计
- 展示最新 10 条项目记录（按时间倒序）
- 使用 DataFrame 表格展示，清晰易读

### 4. 界面优化
- 显示分析结果时自动过滤 JSON 代码块，保持界面干净
- Word 导出时也会自动过滤 JSON 代码块
- 历史记录保存完整内容（包含 JSON），但显示时过滤

## 🔧 技术实现

### 核心函数

1. **`enhance_system_prompt(base_prompt)`**
   - 增强系统提示词，要求 LLM 在分析报告末尾返回结构化 JSON 数据

2. **`extract_json_from_response(response_text)`**
   - 使用正则表达式从 AI 响应中提取 JSON 数据块
   - 支持多种格式匹配，容错性强
   - 验证必需字段，确保数据完整性

3. **`save_to_knowledge_base(json_data)`**
   - 将提取的 JSON 数据保存到 CSV 文件
   - 自动处理 tags 列表转换（列表转分号分隔字符串）
   - 添加时间戳字段

4. **`load_knowledge_base()`**
   - 加载项目知识库 CSV 文件
   - 返回 pandas DataFrame 供界面展示

5. **`clean_markdown_for_display(markdown_text)`**
   - 清理 Markdown 文本，移除 JSON 代码块
   - 用于界面显示和 Word 导出

### JSON 数据结构

```json
{
  "project_name": "项目名称",
  "industry": "所属赛道/行业",
  "tags": ["技术标签1", "技术标签2"],
  "stage": "融资阶段",
  "score": 8,
  "summary": "一句话核心评价",
  "risk_level": "High/Medium/Low"
}
```

### CSV 文件结构

`project_database.csv` 包含以下列：
- `timestamp`: 分析时间（YYYY-MM-DD HH:MM:SS）
- `project_name`: 项目名称
- `industry`: 所属行业
- `tags`: 技术标签（分号分隔）
- `stage`: 融资阶段
- `score`: 投资推荐评分（1-10）
- `summary`: 核心评价
- `risk_level`: 风险等级

## 📦 依赖更新

新增依赖：
- `pandas>=2.0.0` - 用于 CSV 数据处理

已更新 `requirements.txt`，运行以下命令安装：

```bash
pip install -r requirements.txt
```

## 🚀 使用说明

### 正常使用流程（无需额外操作）

1. **上传文件并分析** - 与之前完全相同
2. **查看分析结果** - 界面自动过滤 JSON 代码块，只显示 Markdown 报告
3. **自动保存** - 系统会自动提取并保存项目信息到知识库
4. **查看知识库** - 在侧边栏"📂 项目知识库"区域查看积累的项目数据

### 查看项目知识库

1. 打开应用侧边栏
2. 滚动到"📂 项目知识库"区域
3. 查看项目总数和最新 10 条记录
4. 记录按时间倒序排列，最新记录在最上方

### 导出知识库数据

知识库数据存储在 `project_database.csv` 文件中，可以：
- 直接用 Excel 打开查看和编辑
- 使用 pandas 进行数据分析
- 导入其他系统进行进一步处理

## ⚠️ 注意事项

1. **JSON 提取容错**：如果 AI 响应中未包含有效的 JSON 数据块，系统会静默失败，不影响主分析流程。历史记录仍然会保存完整内容。

2. **数据验证**：只有包含所有必需字段的 JSON 数据才会被保存到知识库。

3. **编码支持**：CSV 文件使用 `utf-8-sig` 编码，在 Windows Excel 中打开不会出现乱码。

4. **性能优化**：侧边栏知识库展示最多显示最新 10 条记录，避免界面加载过慢。

5. **向后兼容**：所有原有功能保持不变，包括：
   - 历史记录功能
   - Word 报告导出
   - 多模式切换
   - 文件上传等

## 🔍 故障排除

### 问题：知识库中没有数据

**可能原因**：
- AI 响应中未包含有效的 JSON 数据块
- JSON 格式不正确或缺少必需字段

**解决方法**：
- 检查 AI 响应末尾是否包含 JSON 代码块
- 查看终端日志是否有提取失败的警告信息
- 可以手动检查 `history_data/` 文件夹中的历史记录，确认 JSON 是否存在

### 问题：知识库显示异常

**可能原因**：
- CSV 文件格式错误
- pandas 库未正确安装

**解决方法**：
- 确认已安装 pandas: `pip install pandas>=2.0.0`
- 检查 `project_database.csv` 文件是否可正常打开
- 如文件损坏，可删除后重新运行分析

## 📝 未来扩展建议

1. **数据筛选和搜索**：添加按行业、评分、风险等级等条件筛选
2. **数据可视化**：添加图表展示项目分布、评分趋势等
3. **数据导出**：支持导出为 Excel、JSON 等格式
4. **数据去重**：自动识别并合并相同项目的多次分析记录
5. **统计分析**：添加项目数量、平均评分、行业分布等统计功能
